#
# Copyright (c) 2019 Nordic Semiconductor
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

source "Kconfig.zephyr"

menu "Nordic Serial Modem"

config SM_CUSTOMER_VERSION
	string "Customer version string"
	help
	   This version is reported together with baseline versions by AT command "#XSMVER".

config SM_AT_BUF_SIZE
	int "AT command buffer size"
	range 128 8192
	default 4096
	help
	  Size of the buffer for incoming AT commands and modem responses.

#
# external XTAL for UART
#
config SM_EXTERNAL_XTAL
	bool "Use external XTAL for UARTE"
	default y

#
# AT command terminator
#
choice
	prompt "Termination mode"
	default SM_CR_TERMINATION
	help
	  Sets the command terminator used by the serial terminal.
	  Available options are:
	  -  CR termination
	  -  LF termination
	  -  CR+LF termination

config SM_CR_TERMINATION
	bool "CR termination"

config SM_LF_TERMINATION
	bool "LF termination"

config SM_CR_LF_TERMINATION
	bool "CR+LF termination"

endchoice

#
# UART buffers (when CMUX is not in use)
#
config SM_UART_RX_BUF_COUNT
	int "Receive buffers for UART"
	range 2 4
	default 3
	help
	  Amount of buffers for receiving (RX) UART traffic.
	  If the buffers are full, UART RX will be disabled until the buffers are processed.
	  These buffers are not used when CMUX is in use.

config SM_UART_RX_BUF_SIZE
	int "Receive buffer size for UART"
	range 128 4096
	default 2048 if BOARD_THINGY91X_NRF9151_NS
	default 256
	help
	  Amount of received (RX), unprocessed, UART traffic that can be held by single buffer.
	  Increase buffer space for Thingy:91 X as hardware flow control is not used.
	  These buffers are not used when CMUX is in use.

config SM_UART_TX_BUF_SIZE
	int "Send buffer size for UART"
	range 128 4096
	default 256
	help
	  Amount of UART traffic waiting to be sent (TX), that can be held.
	  If the buffers are full, will send synchronously.
	  These buffers are not used when CMUX is in use.

config SM_URC_BUFFER_SIZE
	int "TX buffer size for unsolicited result codes (URC)"
	default 4096
	help
	  Buffer, in which unsolicited result codes (URC) are stored before being sent to the host.
	  The buffer has to be large enough to hold the largest URC that can be sent by the modem.
	  Result codes longer than this size will get dropped.

	  The URC in here means an URC from the Modem or from a thread which is not serving sm_work_queue.
	  Messages that are originally sent from sm_work_queue are part of AT-command responses, even though they are indistinguishable from the URCs.

	  This can be reduced if your use cases do not require lengthy notifications.
	  Note: %NCELLMEAS notifications can be nearly 4kB in size,
	  which explains the default value.

config SM_AT_ECHO_MAX_LEN
	int "Maximum length of AT command echo"
	range 2 4096
	default 4096
	help
	  Maximum length of AT command echo that will be sent back to the host when AT command echo is enabled.
	  AT commands longer than this value will be truncated in the echo.
	  The AT command terminator is included in this length and it is always echoed.

config SM_URC_DELAY_WITH_INCOMPLETE_ECHO_MS
	int "Delay for URC transmission when incomplete AT command echo is in progress (ms)"
	default 1000
	help
	  When AT command echo is enabled, and the command is spread over multiple RX buffers,
	  due to its length, or the speed of incoming data (typing), the command echo is considered incomplete
	  until the final part of the command (terminating character) has been received and echoed back to the host.

	  When the AT command echo is incomplete, URC transmissions are delayed by this amount of time for every
	  RX buffer (keystroke, while typing) received until the command echo is complete.

#
# Automatic network attach
#
config SM_AUTO_CONNECT
	bool "Automatically connect to the network on start-up or after a reset"
	help
	  Enables automatic connection to the network using the PDN configuration.

if SM_AUTO_CONNECT

config SM_AUTO_CONNECT_SYSTEM_MODE
	string "System mode for automatic network attach"
	default "1,1,1,0"
	help
	  Defines the default system mode using '%XSYSTEMMODE' AT command for automatic network attach.
	  The format is a comma-separated list of four integers. See the AT command reference for +XSYSTEMMODE for more details.
	  Default value enables LTE-M, NB-IoT, and GNSS, with no LTE preference.

config SM_AUTO_CONNECT_PDN_CONFIG
	bool "PDN configuration for automatic network attach"
	help
	  Enables sending of PDN configuration during automatic network attach.

if SM_AUTO_CONNECT_PDN_CONFIG

config SM_AUTO_CONNECT_PDN_APN
	string "APN for automatic network attach"
	default ""
	help
	  APN to use for automatic network attach.
	  If left empty, the APN configured in the modem will be used.

choice SM_AUTO_CONNECT_PDN_FAMILY
	prompt "PDN family (IP type) for automatic network attach"
	default SM_AUTO_CONNECT_PDN_FAMILY_IPV4V6
	help
	  Select the PDN family (IP address type) to use for automatic network attach.
	  See AT command reference for +CGDCONT for more details.

config SM_AUTO_CONNECT_PDN_FAMILY_IP
	bool "IPv4"
	help
	  Use IPv4 only for the PDN connection.

config SM_AUTO_CONNECT_PDN_FAMILY_IPV6
	bool "IPv6"
	help
	  Use IPv6 only for the PDN connection.

config SM_AUTO_CONNECT_PDN_FAMILY_IPV4V6
	bool "IPv4 and IPv6"
	help
	  Use both IPv4 and IPv6 for the PDN connection (dual stack).

config SM_AUTO_CONNECT_PDN_FAMILY_NON_IP
	bool "Non-IP"
	help
	  Use Non-IP PDN type for the connection.
	  This is used for data transmission without IP headers.

endchoice

config SM_AUTO_CONNECT_PDN_FAMILY_STRING
	string
	default "IP" if SM_AUTO_CONNECT_PDN_FAMILY_IP
	default "IPV6" if SM_AUTO_CONNECT_PDN_FAMILY_IPV6
	default "IPV4V6" if SM_AUTO_CONNECT_PDN_FAMILY_IPV4V6
	default "Non-IP" if SM_AUTO_CONNECT_PDN_FAMILY_NON_IP
	help
	  Internal use only. Represents the selected PDN family as a string.

config SM_AUTO_CONNECT_PDN_AUTH
	int "PDN authentication type for automatic network attach"
	default 0
	range 0 2
	help
	  PDN authentication type to use for automatic network attach.
	  0 = None
	  1 = PAP
	  2 = CHAP

config SM_AUTO_CONNECT_PDN_USERNAME
	string "PDN username for automatic network attach"
	default ""
	help
	  PDN username to use for automatic network attach.
	  Leave empty if no username is required.

config SM_AUTO_CONNECT_PDN_PASSWORD
	string "PDN password for automatic network attach"
	default ""
	help
	  PDN password to use for automatic network attach.
	  Leave empty if no password is required.

endif # SM_AUTO_CONNECT_PDN_CONFIG
endif # SM_AUTO_CONNECT

#
# Data mode
#
config SM_DATAMODE_TERMINATOR
	string "Pattern string to terminate data mode"
	default "+++"
	help
	  Use a pattern to terminate data mode

config SM_DATAMODE_BUF_SIZE
	int "Buffer size for data mode"
	range 1024 8192
	default 4096
	help
	  Size of the buffer for data received in data mode.

#
# Configurable services
#
config SM_SMS
	bool "SMS support"
	default y
	select SMS
	help
	  Support SMS send/receive in plain text

config SM_GNSS
	bool "GNSS support"
	default y

config SM_NRF_CLOUD
	bool "nRF Cloud support"
	default y

config SM_MQTTC
	bool "MQTT client support"
	default y
	select MQTT_LIB
	select MQTT_LIB_TLS

config SM_FULL_FOTA
	bool "Full modem FOTA support"

config SM_DFU_MODEM_FULL
	bool "Full modem DFU support"

config SM_PPP
	bool "PPP support"

config SM_CMUX
	bool "CMUX support"

if SM_PPP

config SM_PPP_FALLBACK_MTU
	int "Fallback MTU to be used by PPP"
	default 1280
	help
	  PPP tries to retrieve the cellular link MTU from the modem (using `AT+CGCONTRDP`).
	  If no MTU is returned by the modem, this value will be used as a fallback.
	  The MTU will be used for sending and receiving of data on both the PPP and cellular links.

endif # SM_PPP

if SM_CMUX || SM_PPP

config SM_MODEM_PIPE_TIMEOUT
	int "Timeout for the CMUX and PPP modem pipe operations in seconds"
	default 10

endif # SM_CMUX || SM_PPP

if SM_MQTTC

config SM_MQTTC_MESSAGE_BUFFER_LEN
	int "Size of the buffer for MQTT library"
	default 512
	help
	  Specifies maximum message size that can be transmitted/received through
	  MQTT (excluding MQTT PUBLISH payload).

endif # SM_MQTTC

if SM_GNSS

config SM_GNSS_OUTPUT_NMEA_ON_CMUX_CHANNEL
	bool "Output NMEA messages on a dedicated CMUX channel"
	depends on SM_CMUX

config SM_GNSS_OUTPUT_NMEA_SATELLITES
	bool "Output NMEA satellite messages (GSV, GSA)"
	default y if SM_LOG_LEVEL_DBG
	depends on SM_LOG_LEVEL_DBG || SM_GNSS_OUTPUT_NMEA_ON_CMUX_CHANNEL
	help
	  If enabled, NMEA messages that pertain to the satellites will be output
	  along with the other NMEA messages. Those are output in debug logs, and
	  can also be output to a dedicated CMUX channel.

config SM_PGPS_INJECT_FIX_DATA
	bool "Inject the data obtained when acquiring a fix"
	default y
	depends on SM_GNSS
	depends on SM_NRF_CLOUD
	depends on NRF_CLOUD_PGPS
	help
	  If enabled, when a fix is acquired the current location and time will
	  be passed to the P-GPS subsystem.
	  It allows to speed up the time it takes to acquire the next fix when
	  A-GNSS is disabled or unavailable.
	  This can be detrimental to short TTFF if the device is expected to move
	  distances longer than a few dozen kilometers between fix attempts.
	  In that case this option should be disabled.

endif # SM_GNSS

if NRF_MODEM_LIB_TRACE

choice NRF_MODEM_LIB_TRACE_BACKEND

config SM_MODEM_TRACE_BACKEND_CMUX
	bool "CMUX modem trace backend"
	depends on SM_CMUX
	help
	  When CMUX is enabled, modem traces are transmitted on a dedicated CMUX channel.
	  The trace channel is the first channel after the AT command channel and the PPP channel.

endchoice # NRF_MODEM_LIB_TRACE_BACKEND

endif

#
# Hardware RX byte counting for UART
#
# Either hardware flow control OR hardware RX byte counting is required to prevent RX data loss.
# When hw-flow-control is enabled in devicetree, it handles flow management efficiently.
# When hw-flow-control is disabled, hardware RX byte counting is enabled to prevent data loss,
# but it consumes more power due to additional timer usage.
#
if UART_ASYNC_API

config UART_0_NRF_HW_ASYNC
	default y if HAS_HW_NRF_UARTE0 && !$(dt_nodelabel_bool_prop,uart0,hw-flow-control)

config UART_0_NRF_HW_ASYNC_TIMER
	default 0 if HAS_HW_NRF_UARTE0 && !$(dt_nodelabel_bool_prop,uart0,hw-flow-control)

config UART_2_NRF_HW_ASYNC
	default y if HAS_HW_NRF_UARTE2 && !$(dt_nodelabel_bool_prop,uart2,hw-flow-control)

config UART_2_NRF_HW_ASYNC_TIMER
	default 2 if HAS_HW_NRF_UARTE2 && !$(dt_nodelabel_bool_prop,uart2,hw-flow-control)

endif # UART_ASYNC_API

module = SM
module-str = serial modem
source "$(ZEPHYR_BASE)/subsys/logging/Kconfig.template.log_config"

rsource "src/lwm2m_carrier/Kconfig"

endmenu
